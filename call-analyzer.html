<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯å•åˆ†æå·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; margin-bottom: 30px; border-radius: 0 0 20px 20px; }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .drop-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 50px 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .drop-zone:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
    .drop-zone .icon { font-size: 48px; margin-bottom: 15px; }
    .drop-zone h3 { margin-bottom: 10px; }
    .drop-zone p { color: #888; font-size: 14px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 25px; color: white; text-align: center; }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card .value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
    .stat-card .label { font-size: 14px; opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; color: #666; font-size: 13px; }
    .tabs { display: flex; gap: 0; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.3s; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .hidden { display: none !important; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #f0f0f0; color: #666; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .hour-bars { display: flex; align-items: flex-end; height: 150px; gap: 3px; padding: 10px 0; }
    .hour-bar { flex: 1; background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); border-radius: 3px 3px 0 0; min-height: 2px; position: relative; }
    .hour-bar:hover { opacity: 0.8; }
    .hour-bar .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; opacity: 0; transition: opacity 0.2s; }
    .hour-bar:hover .tooltip { opacity: 1; }
    .week-bars { display: flex; gap: 10px; margin-top: 20px; }
    .week-item { flex: 1; text-align: center; }
    .week-bar { height: 100px; background: #eee; border-radius: 6px; position: relative; overflow: hidden; }
    .week-bar .fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); border-radius: 6px; transition: height 0.3s; }
    .week-item .day { margin-top: 8px; font-size: 12px; color: #666; }
    .week-item .count { font-size: 11px; color: #888; }
    .progress-container { margin-top: 15px; }
    .progress-item { margin-bottom: 15px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
    .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .progress-fill.blue { background: linear-gradient(90deg, #4facfe, #00f2fe); }
    .progress-fill.green { background: linear-gradient(90deg, #11998e, #38ef7d); }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“± è¯å•åˆ†æå·¥å…·</h1>
    <p>ä¸­å›½ç§»åŠ¨è¯å•æ‰¹é‡åˆ†æ - é€šè¯ç»Ÿè®¡ã€è”ç³»äººåˆ†æã€æ—¶é—´åˆ†æ</p>
  </div>
  
  <div class="container">
    <!-- å¯¼å…¥åŒºåŸŸ -->
    <div class="card" id="importCard">
      <div class="card-title">ğŸ“ å¯¼å…¥è¯å•</div>
      <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <div class="icon">ğŸ“‚</div>
        <h3>ç‚¹å‡»é€‰æ‹©è¯å•æ–‡ä»¶</h3>
        <p>æ”¯æŒé€‰æ‹©å¤šä¸ª CSV æ–‡ä»¶</p>
        <p style="margin-top: 10px; color: #667eea;">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
      </div>
      <input type="file" id="fileInput" multiple accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="startAnalysis()">ğŸš€ å¼€å§‹åˆ†æ</button>
        <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡åŒºåŸŸ -->
    <div id="resultArea" class="hidden">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="value" id="statTotalCalls">-</div>
          <div class="label">æ€»é€šè¯æ¬¡æ•°</div>
        </div>
        <div class="stat-card green">
          <div class="value" id="statTotalDuration">-</div>
          <div class="label">æ€»é€šè¯æ—¶é•¿</div>
        </div>
        <div class="stat-card orange">
          <div class="value" id="statAvgDuration">-</div>
          <div class="label">å¹³å‡å•æ¬¡æ—¶é•¿</div>
        </div>
        <div class="stat-card blue">
          <div class="value" id="statContacts">-</div>
          <div class="label">è”ç³»äººæ•°</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“ˆ ä¸»å«/è¢«å«åˆ†å¸ƒ</div>
        <div class="progress-container">
          <div class="progress-item">
            <div class="progress-label"><span>ğŸ“´ ä¸»å«ï¼ˆæ‰“å‡ºï¼‰</span><span id="outgoingCount">0 æ¬¡</span></div>
            <div class="progress-bar"><div class="progress-fill blue" id="outgoingBar" style="width: 0%"></div></div>
          </div>
          <div class="progress-item">
            <div class="progress-label"><span>ğŸ“² è¢«å«ï¼ˆæ¥å¬ï¼‰</span><span id="incomingCount">0 æ¬¡</span></div>
            <div class="progress-bar"><div class="progress-fill green" id="incomingBar" style="width: 0%"></div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ‘¥ è”ç³»äººåˆ†æ</div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab(this, 'frequency')">é€šè¯é¢‘æ¬¡</div>
          <div class="tab" onclick="switchTab(this, 'strangers')">é™Œç”Ÿäººè¯†åˆ«</div>
          <div class="tab" onclick="switchTab(this, 'frequent')">é«˜é¢‘è”ç³»äºº</div>
        </div>
        <div class="tab-content active" id="tab-frequency">
          <table><thead><tr><th>æ’å</th><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th><th>æœ€åé€šè¯</th></tr></thead><tbody id="frequencyTable"></tbody></table>
        </div>
        <div class="tab-content" id="tab-strangers">
          <table><thead><tr><th>å·ç </th><th>æ—¶é•¿</th><th>æ—¥æœŸ</th></tr></thead><tbody id="strangerTable"></tbody></table>
        </div>
        <div class="tab-content" id="tab-frequent">
          <table><thead><tr><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th></tr></thead><tbody id="frequentTable"></tbody></table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">â° æ—¶é—´åˆ†æ</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="value" id="peakHours">-</div><div class="label">é€šè¯é«˜å³°æ—¶æ®µ</div></div>
          <div class="stat-card green"><div class="value" id="peakDay">-</div><div class="label">é€šè¯é«˜å³°æ—¥</div></div>
          <div class="stat-card orange"><div class="value" id="nightCalls">-</div><div class="label">ç†¬å¤œé€šè¯æ¬¡æ•°</div></div>
          <div class="stat-card blue"><div class="value" id="nightRate">-</div><div class="label">ç†¬å¤œé€šè¯å æ¯”</div></div>
        </div>
        <h4 style="margin: 20px 0 15px;">ğŸ“Š æŒ‰å°æ—¶åˆ†å¸ƒ</h4>
        <div class="hour-bars" id="hourBars"></div>
        <h4 style="margin: 20px 0 15px;">ğŸ“… æŒ‰æ˜ŸæœŸåˆ†å¸ƒ</h4>
        <div class="week-bars" id="weekBars"></div>
      </div>
    </div>
  </div>

  <script src="js/call-analyzer.js"></script>
  <script>
    let selectedFiles = [];
    const analyzer = new CallAnalyzer();

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        selectedFiles = files;
        alert(`å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`);
      }
    }

    async function startAnalysis() {
      if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¯å•æ–‡ä»¶');
        return;
      }
      analyzer.calls = [];
      for (const file of selectedFiles) {
        const content = await file.text();
        const tempFile = '/tmp/temp_' + file.name;
        await fetch(tempFile, { method: 'PUT', body: content }).catch(() => {});
        const fs = {
          readFileSync: () => content,
          existsSync: () => true
        };
        const tempAnalyzer = new CallAnalyzer();
        tempAnalyzer.calls = tempAnalyzer.parseCSV(tempFile);
        analyzer.calls.push(...tempAnalyzer.calls);
      }
      document.getElementById('resultArea').classList.remove('hidden');
      document.getElementById('importCard').classList.add('hidden');
      loadStatistics();
      loadContacts();
      loadTimeAnalysis();
    }

    function loadStatistics() {
      const stats = analyzer.getStatistics();
      document.getElementById('statTotalCalls').textContent = stats.totalCalls + ' æ¬¡';
      document.getElementById('statTotalDuration').textContent = stats.totalDuration;
      document.getElementById('statAvgDuration').textContent = stats.avgDuration;
      const contacts = analyzer.getContactAnalysis();
      document.getElementById('statContacts').textContent = contacts.totalContacts + ' äºº';
      const incoming = stats.callTypes.incoming;
      const outgoing = stats.callTypes.outgoing;
      const total = incoming + outgoing;
      document.getElementById('incomingCount').textContent = `${incoming} æ¬¡ (${total > 0 ? Math.round(incoming/total*100) : 0}%)`;
      document.getElementById('outgoingCount').textContent = `${outgoing} æ¬¡ (${total > 0 ? Math.round(outgoing/total*100) : 0}%)`;
      document.getElementById('incomingBar').style.width = total > 0 ? `${incoming/total*100}%` : '0%';
      document.getElementById('outgoingBar').style.width = total > 0 ? `${outgoing/total*100}%` : '0%';
    }

    function loadContacts() {
      const contacts = analyzer.getContactAnalysis();
      document.getElementById('frequencyTable').innerHTML = contacts.topContacts.slice(0, 20).map((c, i) => `<tr><td>${i+1}</td><td>${c.phone}</td><td>${c.count} æ¬¡</td><td>${c.durationStr}</td><td>${c.lastCall?.split(' ')[0] || '-'}</td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:#888">æš‚æ— æ•°æ®</td></tr>';
      document.getElementById('strangerTable').innerHTML = contacts.strangerList.map(c => `<tr><td>${c.phone}</td><td>${c.durationStr}</td><td>${c.lastCall?.split(' ')[0] || '-'}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é™Œç”Ÿäºº</td></tr>';
      document.getElementById('frequentTable').innerHTML = contacts.frequentList.map(c => `<tr><td>${c.phone}</td><td>${c.count} æ¬¡</td><td>${c.durationStr}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é«˜é¢‘è”ç³»äºº</td></tr>';
    }

    function loadTimeAnalysis() {
      const time = analyzer.getTimeAnalysis();
      document.getElementById('peakHours').textContent = time.peakHours.join('ã€') || '-';
      document.getElementById('peakDay').textContent = time.peakDay || '-';
      document.getElementById('nightCalls').textContent = time.nightCalls + ' æ¬¡';
      document.getElementById('nightRate').textContent = time.nightRate + '%';
      const maxHour = Math.max(...time.hourDistribution);
      document.getElementById('hourBars').innerHTML = time.hourDistribution.map((count, hour) => `<div class="hour-bar" style="height:${maxHour > 0 ? (count/maxHour*100) : 0}%"><div class="tooltip">${hour}:00 - ${count}æ¬¡</div></div>`).join('');
      const maxDay = Math.max(...time.dayDistribution.map(d => d.count));
      document.getElementById('weekBars').innerHTML = time.dayDistribution.map(d => `<div class="week-item"><div class="week-bar"><div class="fill" style="height:${maxDay > 0 ? (d.count/maxDay*100) : 0}%"></div></div><div class="day">${d.day}</div><div class="count">${d.count}æ¬¡</div></div>`).join('');
    }

    function switchTab(el, tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    function clearData() {
      selectedFiles = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('resultArea').classList.add('hidden');
      document.getElementById('importCard').classList.remove('hidden');
    }
  </script>
</body>
</html>
