<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯å•åˆ†æå·¥å…·</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 20px; text-align: center; margin-bottom: 30px; border-radius: 0 0 20px 20px; }
    .header h1 { font-size: 28px; margin-bottom: 10px; }
    .header p { font-size: 14px; opacity: 0.9; }
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
    .drop-zone { border: 2px dashed #ddd; border-radius: 12px; padding: 60px 20px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .drop-zone:hover { border-color: #667eea; background: rgba(102, 126, 234, 0.05); }
    .drop-zone .icon { font-size: 48px; margin-bottom: 15px; }
    .drop-zone h3 { margin-bottom: 10px; }
    .drop-zone p { color: #888; font-size: 14px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 25px; color: white; text-align: center; }
    .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card .value { font-size: 32px; font-weight: 700; margin-bottom: 5px; }
    .stat-card .label { font-size: 14px; opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; color: #666; }
    .tabs { display: flex; gap: 0; border-bottom: 2px solid #eee; margin-bottom: 20px; }
    .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.3s; font-size: 14px; color: #666; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .hidden { display: none !important; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-secondary { background: #f0f0f0; color: #666; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
    .hour-bars { display: flex; align-items: flex-end; height: 150px; gap: 2px; padding: 10px 0; }
    .hour-bar { flex: 1; background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%); border-radius: 2px 2px 0 0; min-height: 2px; }
    .week-bars { display: flex; gap: 8px; margin-top: 20px; }
    .week-item { flex: 1; text-align: center; }
    .week-bar { height: 100px; background: #eee; border-radius: 6px; position: relative; overflow: hidden; }
    .week-bar .fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); }
    .week-item .day { margin-top: 8px; font-size: 12px; color: #666; }
    .week-item .count { font-size: 11px; color: #888; }
    .progress-container { margin-top: 15px; }
    .progress-item { margin-bottom: 12px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
    .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; }
    .progress-fill.blue { background: linear-gradient(90deg, #4facfe, #00f2fe); }
    .progress-fill.green { background: linear-gradient(90deg, #11998e, #38ef7d); }
    .file-list { margin-top: 15px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; }
    .file-item .name { font-size: 13px; }
    .file-item .remove { color: #f5576c; cursor: pointer; font-size: 12px; margin-left: 10px; }
    .loading { text-align: center; padding: 40px; }
    .loading .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-size: 14px; z-index: 1000; }
    .notification.success { background: linear-gradient(135deg, #11998e, #38ef7d); }
    .notification.error { background: linear-gradient(135deg, #f5576c, #f093fb); }
  </style>
</head>
<body>
  <div class="header">
    <h1>è¯å•åˆ†æå·¥å…·</h1>
    <p>æ”¯æŒ CSVã€XLSã€XLSX æ ¼å¼</p>
  </div>
  
  <div class="container">
    <div class="card" id="importCard">
      <div class="card-title">å¯¼å…¥è¯å•</div>
      <div class="drop-zone" id="dropZone">
        <div class="icon">ğŸ“‚</div>
        <h3>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</h3>
        <p>æ”¯æŒ CSVã€XLSã€XLSXï¼Œå¯å¤šé€‰ï¼Œå¯æ‹–æ‹½</p>
      </div>
      <input type="file" id="fileInput" multiple accept=".csv,.xls,.xlsx" style="display: none;">
      <div id="fileList" class="file-list"></div>
      <div class="btn-group">
        <button class="btn btn-primary" id="analyzeBtn">ğŸš€ å¼€å§‹åˆ†æ</button>
        <button class="btn btn-secondary" id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
      </div>
    </div>

    <div class="card hidden" id="loadingArea">
      <div class="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨è§£æè¯å•æ–‡ä»¶...</p>
      </div>
    </div>

    <div id="resultArea" class="hidden">
      <div class="stats-grid">
        <div class="stat-card"><div class="value" id="statTotalCalls">-</div><div class="label">æ€»é€šè¯æ¬¡æ•°</div></div>
        <div class="stat-card green"><div class="value" id="statTotalDuration">-</div><div class="label">æ€»é€šè¯æ—¶é•¿</div></div>
        <div class="stat-card orange"><div class="value" id="statAvgDuration">-</div><div class="label">å¹³å‡å•æ¬¡æ—¶é•¿</div></div>
        <div class="stat-card blue"><div class="value" id="statContacts">-</div><div class="label">è”ç³»äººæ•°</div></div>
      </div>

      <div class="card">
        <div class="card-title">ä¸»å«/è¢«å«åˆ†å¸ƒ</div>
        <div class="progress-container">
          <div class="progress-item">
            <div class="progress-label"><span>ğŸ“´ ä¸»å«</span><span id="outgoingCount">0 (0%)</span></div>
            <div class="progress-bar"><div class="progress-fill blue" id="outgoingBar" style="width: 0%"></div></div>
          </div>
          <div class="progress-item">
            <div class="progress-label"><span>ğŸ“² è¢«å«</span><span id="incomingCount">0 (0%)</span></div>
            <div class="progress-bar"><div class="progress-fill green" id="incomingBar" style="width: 0%"></div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">è”ç³»äººåˆ†æ</div>
        <div class="tabs">
          <div class="tab active" data-tab="frequency">é€šè¯é¢‘æ¬¡</div>
          <div class="tab" data-tab="strangers">é™Œç”Ÿäºº</div>
          <div class="tab" data-tab="frequent">é«˜é¢‘è”ç³»äºº</div>
        </div>
        <div class="tab-content active" id="tab-frequency">
          <table><thead><tr><th>æ’å</th><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th><th>æœ€åé€šè¯</th></tr></thead><tbody id="frequencyTable"></tbody></table>
        </div>
        <div class="tab-content" id="tab-strangers">
          <table><thead><tr><th>å·ç </th><th>æ—¶é•¿</th><th>æ—¥æœŸ</th></tr></thead><tbody id="strangerTable"></tbody></table>
        </div>
        <div class="tab-content" id="tab-frequent">
          <table><thead><tr><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th></tr></thead><tbody id="frequentTable"></tbody></table>
        </div>
      </div>

      <div class="card">
        <div class="card-title">æ—¶é—´åˆ†æ</div>
        <div class="stats-grid">
          <div class="stat-card"><div class="value" id="peakHours">-</div><div class="label">é«˜å³°æ—¶æ®µ</div></div>
          <div class="stat-card green"><div class="value" id="peakDay">-</div><div class="label">é«˜å³°æ—¥</div></div>
          <div class="stat-card orange"><div class="value" id="nightCalls">-</div><div class="label">ç†¬å¤œæ¬¡æ•°</div></div>
          <div class="stat-card blue"><div class="value" id="nightRate">-</div><div class="label">ç†¬å¤œå æ¯”</div></div>
        </div>
        <h4 style="margin: 20px 0 15px;">ğŸ“Š æŒ‰å°æ—¶åˆ†å¸ƒ</h4>
        <div class="hour-bars" id="hourBars"></div>
        <h4 style="margin: 20px 0 15px;">ğŸ“… æŒ‰æ˜ŸæœŸåˆ†å¸ƒ</h4>
        <div class="week-bars" id="weekBars"></div>
      </div>
    </div>
  </div>

  <script src="analyzer.js"></script>
  <script>
    const analyzer = new CallAnalyzer();
    let selectedFiles = [];
    
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.onclick = function() { fileInput.click(); };
    
    fileInput.onchange = function(e) {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        selectedFiles = files;
        renderFileList();
        showNotification('å·²é€‰æ‹© ' + files.length + ' ä¸ªæ–‡ä»¶', 'success');
      }
    };
    
    dropZone.ondragover = function(e) { e.preventDefault(); dropZone.style.borderColor = '#667eea'; };
    dropZone.ondragleave = function() { dropZone.style.borderColor = '#ddd'; };
    dropZone.ondrop = function(e) {
      e.preventDefault();
      dropZone.style.borderColor = '#ddd';
      const files = Array.from(e.dataTransfer.files);
      if (files.length > 0) {
        selectedFiles = files;
        renderFileList();
        showNotification('å·²é€‰æ‹© ' + files.length + ' ä¸ªæ–‡ä»¶', 'success');
      }
    };
    
    function renderFileList() {
      const container = document.getElementById('fileList');
      if (selectedFiles.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedFiles.map(function(file, i) {
        return '<div class="file-item"><span class="name">ğŸ“„ ' + file.name + '</span><span class="remove" onclick="removeFile(' + i + ')">âœ•</span></div>';
      }).join('');
    }
    
    function removeFile(i) {
      selectedFiles.splice(i, 1);
      renderFileList();
    }
    
    function showNotification(msg, type) {
      const n = document.createElement('div');
      n.className = 'notification ' + type;
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(function() { n.remove(); }, 3000);
    }
    
    document.getElementById('analyzeBtn').onclick = async function() {
      if (selectedFiles.length === 0) {
        showNotification('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
        return;
      }
      
      document.getElementById('importCard').classList.add('hidden');
      document.getElementById('loadingArea').classList.remove('hidden');
      
      analyzer.calls = [];
      
      for (const file of selectedFiles) {
        try {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data);
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const csv = json.map(function(row) {
            return row.map(function(c) {
              return String(c || '');
            }).join(',');
          }).join('\n');
          const calls = analyzer.parseCSV(csv);
          analyzer.calls.push.apply(analyzer.calls, calls);
        } catch (e) {
          console.error('è§£æå¤±è´¥:', file.name, e);
        }
      }
      
      document.getElementById('loadingArea').classList.add('hidden');
      document.getElementById('resultArea').classList.remove('hidden');
      
      loadStatistics();
      loadContacts();
      loadTimeAnalysis();
      
      showNotification('åˆ†æå®Œæˆï¼å…± ' + analyzer.calls.length + ' æ¡è®°å½•', 'success');
    };
    
    document.getElementById('clearBtn').onclick = function() {
      selectedFiles = [];
      fileInput.value = '';
      renderFileList();
      document.getElementById('resultArea').classList.add('hidden');
      document.getElementById('importCard').classList.remove('hidden');
      analyzer.calls = [];
      showNotification('å·²æ¸…é™¤');
    };
    
    function loadStatistics() {
      const stats = analyzer.getStatistics();
      const contacts = analyzer.getContactAnalysis();
      document.getElementById('statTotalCalls').textContent = stats.totalCalls + ' æ¬¡';
      document.getElementById('statTotalDuration').textContent = stats.totalDuration;
      document.getElementById('statAvgDuration').textContent = stats.avgDuration;
      document.getElementById('statContacts').textContent = contacts.totalContacts + ' äºº';
      
      const incoming = stats.callTypes.incoming;
      const outgoing = stats.callTypes.outgoing;
      const total = incoming + outgoing;
      
      document.getElementById('incomingCount').textContent = incoming + ' (' + (total ? Math.round(incoming/total*100) : 0) + '%)';
      document.getElementById('outgoingCount').textContent = outgoing + ' (' + (total ? Math.round(outgoing/total*100) : 0) + '%)';
      document.getElementById('incomingBar').style.width = total ? incoming/total*100 + '%' : '0%';
      document.getElementById('outgoingBar').style.width = total ? outgoing/total*100 + '%' : '0%';
    }
    
    function loadContacts() {
      const contacts = analyzer.getContactAnalysis();
      document.getElementById('frequencyTable').innerHTML = contacts.topContacts.slice(0, 20).map(function(c, i) {
        return '<tr><td>' + (i+1) + '</td><td>' + c.phone + '</td><td>' + c.count + ' æ¬¡</td><td>' + c.durationStr + '</td><td>' + (c.lastCall ? c.lastCall.split(' ')[0] : '-') + '</td></tr>';
      }).join('') || '<tr><td colspan="5" style="text-align:center;color:#888">æš‚æ— æ•°æ®</td></tr>';
      
      document.getElementById('strangerTable').innerHTML = contacts.strangerList.map(function(c) {
        return '<tr><td>' + c.phone + '</td><td>' + c.durationStr + '</td><td>' + (c.lastCall ? c.lastCall.split(' ')[0] : '-') + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é™Œç”Ÿäºº</td></tr>';
      
      document.getElementById('frequentTable').innerHTML = contacts.frequentList.map(function(c) {
        return '<tr><td>' + c.phone + '</td><td>' + c.count + ' æ¬¡</td><td>' + c.durationStr + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é«˜é¢‘è”ç³»äºº</td></tr>';
    }
    
    function loadTimeAnalysis() {
      const time = analyzer.getTimeAnalysis();
      document.getElementById('peakHours').textContent = time.peakHours.join('ã€') || '-';
      document.getElementById('peakDay').textContent = time.peakDay || '-';
      document.getElementById('nightCalls').textContent = time.nightCalls + ' æ¬¡';
      document.getElementById('nightRate').textContent = time.nightRate + '%';
      
      const maxHour = Math.max.apply(null, time.hourDistribution) || 1;
      document.getElementById('hourBars').innerHTML = time.hourDistribution.map(function(count, hour) {
        return '<div class="hour-bar" style="height:' + (count/maxHour*100) + '%"></div>';
      }).join('');
      
      const maxDay = Math.max.apply(null, time.dayDistribution.map(function(d) { return d.count; })) || 1;
      document.getElementById('weekBars').innerHTML = time.dayDistribution.map(function(d) {
        return '<div class="week-item"><div class="week-bar"><div class="fill" style="height:' + (d.count/maxDay*100) + '%"></div></div><div class="day">' + d.day + '</div><div class="count">' + d.count + 'æ¬¡</div></div>';
      }).join('');
    }
    
    document.querySelectorAll('.tab').forEach(function(tab) {
      tab.onclick = function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      };
    });
  </script>
</body>
</html>
