<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>话单分析工具</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:25px;text-align:center;border-radius:10px;margin-bottom:20px}
    .header h1{margin:0;font-size:24px}
    .card{background:white;border-radius:10px;padding:20px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    h3{margin:0 0 15px;font-size:16px}
    .drop-zone{border:2px dashed #ddd;border-radius:8px;padding:40px;text-align:center;cursor:pointer;margin-bottom:10px}
    .drop-zone:hover{border-color:#667eea}
    .btn{padding:10px 18px;border:none;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px}
    .btn-primary{background:#667eea;color:white}
    .btn-secondary{background:#f0f0f0;color:#666}
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:15px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:15px;border-radius:8px;text-align:center}
    .stat-card.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
    .stat-card.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
    .stat-card.blue{background:linear-gradient(135deg,#4facfe,#00f2fe)}
    .stat-card .value{font-size:20px;font-weight:bold}
    .stat-card .label{font-size:11px;opacity:0.9}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eee}
    th{background:#f8f9fa;color:#666}
    .file-list{margin:10px 0}
    .file-item{padding:6px 10px;background:#f8f9fa;border-radius:4px;margin-bottom:4px;font-size:13px}
    .hidden{display:none}
    .progress-wrap{margin:15px 0}
    .progress-bar{height:12px;background:#eee;border-radius:6px}
    .progress-fill{height:100%;background:#667eea;border-radius:6px}
    .loading-wrap{text-align:center;padding:30px}
    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#38ef7d;color:white;padding:12px 24px;border-radius:8px;font-size:14px;z-index:1000}
  </style>
</head>
<body>
  <div class="header">
    <h1>话单分析工具</h1>
    <p>支持 CSV、XLS、XLSX 格式</p>
  </div>
  
  <div id="pageImport">
    <div class="card">
      <h3>选择话单文件</h3>
      <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <p>点击选择文件（支持 CSV、XLS、XLSX）</p>
        <p style="font-size:12px;color:#999">可多选</p>
      </div>
      <input type="file" id="fileInput" multiple accept=".csv,.xls,.xlsx" style="display:none" onchange="handleFiles()">
      <div id="fileList" class="file-list"></div>
      <div>
        <button class="btn btn-primary" onclick="startAnalyze()">开始分析</button>
        <button class="btn btn-secondary" onclick="clearFiles()">清除</button>
      </div>
    </div>
  </div>

  <div id="pageLoading" class="card hidden">
    <div class="loading-wrap">
      <p id="loadingMsg">正在解析...</p>
    </div>
    <div class="progress-wrap">
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px">
        <span id="progressFile">-</span>
        <span id="progressNum">0/0</span>
      </div>
      <div class="progress-bar">
        <div id="progressBar" class="progress-fill" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div id="pageResult" class="hidden">
    <div class="stats-grid">
      <div class="stat-card"><div class="value" id="resCalls">-</div><div class="label">通话次数</div></div>
      <div class="stat-card green"><div class="value" id="resDuration">-</div><div class="label">通话时长</div></div>
      <div class="stat-card orange"><div class="value" id="resAvg">-</div><div class="label">平均时长</div></div>
      <div class="stat-card blue"><div class="value" id="resContacts">-</div><div class="label">联系人数</div></div>
    </div>
    <div class="card">
      <h3>联系人 TOP20</h3>
      <table>
        <thead><tr><th>排名</th><th>号码</th><th>次数</th><th>时长</th></tr></thead>
        <tbody id="resTable"></tbody>
      </table>
    </div>
    <div style="text-align:center">
      <button class="btn btn-secondary" onclick="back()">重新分析</button>
    </div>
  </div>

  <script src="analyzer.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    var files = [];
    var analyzer = new CallAnalyzer();
    var allCalls = [];

    function toast(msg) {
      var t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(function(){t.remove();},2000);
    }

    function handleFiles() {
      var input = document.getElementById('fileInput');
      if (input.files.length > 0) {
        files = Array.from(input.files);
        var html = '';
        for (var i = 0; i < files.length; i++) {
          html += '<div class="file-item">' + files[i].name + '</div>';
        }
        document.getElementById('fileList').innerHTML = html;
        toast('已选择 ' + files.length + ' 个文件');
      }
    }

    function clearFiles() {
      files = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('fileList').innerHTML = '';
    }

    function showPage(id) {
      document.getElementById('pageImport').className = 'hidden';
      document.getElementById('pageLoading').className = 'hidden';
      document.getElementById('pageResult').className = 'hidden';
      document.getElementById(id).className = '';
    }

    function back() {
      clearFiles();
      showPage('pageImport');
    }

    function startAnalyze() {
      if (files.length === 0) {
        alert('请先选择文件');
        return;
      }
      
      showPage('pageLoading');
      allCalls = [];
      var idx = 0;
      var total = files.length;
      
      function next() {
        if (idx >= total) {
          document.getElementById('loadingMsg').textContent = '完成！共 ' + allCalls.length + ' 条';
          setTimeout(showResult, 500);
          return;
        }
        
        var f = files[idx];
        document.getElementById('progressNum').textContent = (idx+1) + '/' + total;
        document.getElementById('progressFile').textContent = f.name;
        document.getElementById('progressBar').style.width = ((idx/total)*100) + '%';
        
        var ext = f.name.toLowerCase().split('.').pop();
        
        if (ext === 'csv') {
          readCSV(f, function(calls) {
            allCalls = allCalls.concat(calls);
            idx++;
            next();
          });
        } else {
          readExcel(f, function(calls) {
            allCalls = allCalls.concat(calls);
            idx++;
            next();
          });
        }
      }
      
      next();
    }

    function readCSV(f, cb) {
      var r = new FileReader();
      r.onload = function(e) {
        try {
          var c = analyzer.parseCSV(e.target.result);
          cb(c);
        } catch(err) { cb([]); }
      };
      r.onerror = function() { cb([]); };
      r.readAsText(f);
    }

    function readExcel(f, cb) {
      var r = new FileReader();
      r.onload = function(e) {
        try {
          var data = new Uint8Array(e.target.result);
          var wb = XLSX.read(data, {type: 'array'});
          var sheet = wb.Sheets[wb.SheetNames[0]];
          var json = XLSX.utils.sheet_to_json(sheet, {header: 1});
          var csv = json.map(function(row){return row.map(function(c){return String(c||'')}).join(',')}).join('\n');
          var c = analyzer.parseCSV(csv);
          cb(c);
        } catch(err) { cb([]); }
      };
      r.onerror = function() { cb([]); };
      r.readAsArrayBuffer(f);
    }

    function showResult() {
      showPage('pageResult');
      analyzer.calls = allCalls;
      
      var stats = analyzer.getStatistics();
      var contacts = analyzer.getContactAnalysis();
      
      document.getElementById('resCalls').textContent = stats.totalCalls;
      document.getElementById('resDuration').textContent = stats.totalDuration;
      document.getElementById('resAvg').textContent = stats.avgDuration;
      document.getElementById('resContacts').textContent = contacts.totalContacts;
      
      var html = '';
      var list = contacts.topContacts.slice(0, 20);
      for (var i = 0; i < list.length; i++) {
        var c = list[i];
        html += '<tr><td>' + (i+1) + '</td><td>' + c.phone + '</td><td>' + c.count + '</td><td>' + c.durationStr + '</td></tr>';
      }
      document.getElementById('resTable').innerHTML = html || '<tr><td colspan="4" style="text-align:center">暂无数据</td></tr>';
      
      toast('分析完成！');
    }
  </script>
</body>
</html>
