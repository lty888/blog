<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¯å•åˆ†æå·¥å…·</title>
  <script src="analyzer.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;text-align:center;border-radius:10px;margin-bottom:20px}
    .header h1{margin:0}
    .card{background:white;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .drop-zone{border:2px dashed #ddd;border-radius:10px;padding:50px;text-align:center;cursor:pointer;margin-bottom:15px}
    .drop-zone:hover{border-color:#667eea;background:rgba(102,126,234,0.05)}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-right:10px}
    .btn-primary{background:#667eea;color:white}
    .btn-secondary{background:#f0f0f0;color:#666}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:10px;text-align:center}
    .stat-card.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
    .stat-card.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
    .stat-card.blue{background:linear-gradient(135deg,#4facfe,#00f2fe)}
    .stat-card .value{font-size:24px;font-weight:bold}
    .stat-card .label{font-size:12px;opacity:0.9}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee}
    th{background:#f8f9fa;color:#666}
    .hidden{display:none}
    .file-list{margin:10px 0}
    .file-item{padding:8px;background:#f8f9fa;border-radius:5px;margin-bottom:5px}
    .progress-container{margin:20px 0}
    .progress-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:14px}
    .progress-bar{height:20px;background:#eee;border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;border-radius:10px}
    .status-text{padding:20px;text-align:center;font-size:16px;color:#666}
    .status-text .spinner{display:inline-block;width:30px;height:30px;border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .file-status{margin-top:15px;font-size:14px;color:#888}
    .file-status .done{color:#38ef7d}
    .file-status .current{color:#667eea;font-weight:bold}
  </style>
</head>
<body>
  <div class="header">
    <h1>è¯å•åˆ†æå·¥å…·</h1>
    <p>æ”¯æŒ CSVã€XLSã€XLSX æ ¼å¼</p>
  </div>
  
  <div class="card" id="importCard">
    <h3>å¯¼å…¥è¯å•</h3>
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
      <p>ğŸ“‚ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
      <p style="color:#888">æ”¯æŒ CSVã€XLSã€XLSX æ ¼å¼</p>
    </div>
    <input type="file" id="fileInput" multiple accept=".csv,.xls,.xlsx" style="display:none" onchange="handleFiles()">
    <div id="fileList" class="file-list"></div>
    <button class="btn btn-primary" onclick="analyze()">å¼€å§‹åˆ†æ</button>
    <button class="btn btn-secondary" onclick="clearFiles()">æ¸…é™¤</button>
  </div>

  <div class="card" id="loadingCard">
    <div class="status-text">
      <span class="spinner"></span>
      <span id="loadingText">æ­£åœ¨å‡†å¤‡...</span>
    </div>
    <div class="progress-container">
      <div class="progress-label">
        <span>è§£æè¿›åº¦</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar" style="width:0%"></div>
      </div>
    </div>
    <div class="file-status" id="fileStatus"></div>
  </div>

  <div id="resultArea" class="hidden">
    <div class="stats-grid">
      <div class="stat-card"><div class="value" id="totalCalls">-</div><div class="label">æ€»é€šè¯æ¬¡æ•°</div></div>
      <div class="stat-card green"><div class="value" id="totalDuration">-</div><div class="label">æ€»é€šè¯æ—¶é•¿</div></div>
      <div class="stat-card orange"><div class="value" id="avgDuration">-</div><div class="label">å¹³å‡æ—¶é•¿</div></div>
      <div class="stat-card blue"><div class="value" id="totalContacts">-</div><div class="label">è”ç³»äººæ•°</div></div>
    </div>

    <div class="card">
      <h3>ä¸»å«/è¢«å«åˆ†å¸ƒ</h3>
      <p>ä¸»å«: <span id="outgoingText">0 (0%)</span></p>
      <div class="progress-bar" style="height:8px"><div class="progress-fill" id="outgoingBar" style="width:0%;background:#4facfe"></div></div>
      <p>è¢«å«: <span id="incomingText">0 (0%)</span></p>
      <div class="progress-bar" style="height:8px"><div class="progress-fill" id="incomingBar" style="width:0%;background:#38ef7d"></div></div>
    </div>

    <div class="card">
      <h3>è”ç³»äºº TOP20</h3>
      <table>
        <thead><tr><th>æ’å</th><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th><th>æœ€åé€šè¯</th></tr></thead>
        <tbody id="contactTable"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <script>
    var selectedFiles = [];
    var analyzer = new CallAnalyzer();

    function handleFiles() {
      var input = document.getElementById('fileInput');
      if (input.files.length > 0) {
        selectedFiles = Array.from(input.files);
        var html = '';
        for (var i = 0; i < selectedFiles.length; i++) {
          html += '<div class="file-item">' + selectedFiles[i].name + '</div>';
        }
        document.getElementById('fileList').innerHTML = html;
      }
    }

    function clearFiles() {
      selectedFiles = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('fileList').innerHTML = '';
      document.getElementById('resultArea').className = 'hidden';
    }

    function updateProgress(percent, fileName, current, total) {
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent + '%';
      if (fileName) {
        var statusHtml = '<span class="current">æ­£åœ¨è§£æ: ' + fileName + '</span>';
        if (current > 1) {
          statusHtml += '<br><span class="done">å·²å®Œæˆ: ' + (current - 1) + '/' + total + ' ä¸ªæ–‡ä»¶</span>';
        }
        document.getElementById('fileStatus').innerHTML = statusHtml;
      }
    }

    async function analyze() {
      if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      document.getElementById('importCard').className = 'hidden';
      document.getElementById('loadingCard').style.display = 'block';
      document.getElementById('resultArea').className = 'hidden';
      
      analyzer.calls = [];
      var allCalls = [];
      var total = selectedFiles.length;

      try {
        for (var i = 0; i < total; i++) {
          var file = selectedFiles[i];
          var percent = Math.round(((i) / total) * 100);
          updateProgress(percent, file.name, i + 1, total);
          
          var ext = file.name.toLowerCase().split('.').pop();
          var calls = [];
          
          try {
            if (ext === 'csv') {
              calls = await parseCSVFile(file);
            } else if (ext === 'xlsx' || ext === 'xls') {
              calls = await parseExcelFile(file);
            } else {
              calls = await parseCSVFile(file);
            }
          } catch (e) {
            console.warn('è§£ææ–‡ä»¶å¤±è´¥ ' + file.name + ': ' + e.message);
          }
          
          for (var j = 0; j < calls.length; j++) {
            allCalls.push(calls[j]);
          }
        }
        
        updateProgress(100, 'è§£æå®Œæˆ!', total, total);
        
        setTimeout(function() {
          analyzer.calls = allCalls;
          showResults();
        }, 500);
        
      } catch (e) {
        document.getElementById('loadingText').innerHTML = '<span style="color:#f5576c">è§£æå¤±è´¥: ' + e.message + '</span>';
      }
    }

    function parseCSVFile(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var calls = analyzer.parseCSV(e.target.result);
            resolve(calls);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = function() { reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥')); };
        reader.readAsText(file);
      });
    }

    function parseExcelFile(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function(e) {
          try {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type: 'array'});
            var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            var json = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            var csv = json.map(function(row) {
              return row.map(function(c) { return String(c || ''); }).join(',');
            }).join('\n');
            var calls = analyzer.parseCSV(csv);
            resolve(calls);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = function() { reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥')); };
        reader.readAsArrayBuffer(file);
      });
    }

    function showResults() {
      document.getElementById('loadingCard').style.display = 'none';
      document.getElementById('resultArea').className = '';
      
      var stats = analyzer.getStatistics();
      var contacts = analyzer.getContactAnalysis();
      
      document.getElementById('totalCalls').textContent = stats.totalCalls;
      document.getElementById('totalDuration').textContent = stats.totalDuration;
      document.getElementById('avgDuration').textContent = stats.avgDuration;
      document.getElementById('totalContacts').textContent = contacts.totalContacts;
      
      var incoming = stats.callTypes.incoming;
      var outgoing = stats.callTypes.outgoing;
      var total = incoming + outgoing;
      document.getElementById('incomingText').textContent = incoming + ' (' + (total ? Math.round(incoming/total*100) : 0) + '%)';
      document.getElementById('outgoingText').textContent = outgoing + ' (' + (total ? Math.round(outgoing/total*100) : 0) + '%)';
      document.getElementById('incomingBar').style.width = total ? incoming/total*100 + '%' : '0%';
      document.getElementById('outgoingBar').style.width = total ? outgoing/total*100 + '%' : '0%';
      
      var html = '';
      var topContacts = contacts.topContacts.slice(0, 20);
      for (var i = 0; i < topContacts.length; i++) {
        var c = topContacts[i];
        html += '<tr><td>' + (i+1) + '</td><td>' + c.phone + '</td><td>' + c.count + '</td><td>' + c.durationStr + '</td><td>' + (c.lastCall ? c.lastCall.split(' ')[0] : '-') + '</td></tr>';
      }
      document.getElementById('contactTable').innerHTML = html || '<tr><td colspan="5" style="text-align:center">æš‚æ— æ•°æ®</td></tr>';
      
      alert('åˆ†æå®Œæˆï¼å…± ' + analyzer.calls.length + ' æ¡è®°å½•');
    }
  </script>
</body>
</html>
