<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¯å•åˆ†æå·¥å…·</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;padding:20px}
    .header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;text-align:center;border-radius:10px 10px 0 0;margin-bottom:20px}
    .header h1{margin:0 0 10px}
    .card{background:white;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .drop-zone{border:2px dashed #ddd;border-radius:10px;padding:50px;text-align:center;cursor:pointer;margin-bottom:15px}
    .drop-zone:hover{border-color:#667eea;background:rgba(102,126,234,0.05)}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;margin-right:10px}
    .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
    .btn-secondary{background:#f0f0f0;color:#666}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
    .stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:20px;border-radius:10px;text-align:center}
    .stat-card.green{background:linear-gradient(135deg,#11998e,#38ef7d)}
    .stat-card.orange{background:linear-gradient(135deg,#f093fb,#f5576c)}
    .stat-card.blue{background:linear-gradient(135deg,#4facfe,#00f2fe)}
    .stat-card .value{font-size:24px;font-weight:bold;margin-bottom:5px}
    .stat-card .label{font-size:12px;opacity:0.9}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f8f9fa;font-weight:600;color:#666}
    .tabs{display:flex;border-bottom:2px solid #eee;margin-bottom:15px}
    .tab{padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:#667eea;border-bottom-color:#667eea;font-weight:600}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .hidden{display:none}
    .file-list{margin-top:10px}
    .file-item{padding:8px 15px;background:#f8f9fa;border-radius:5px;margin-bottom:5px;display:flex;justify-content:space-between}
    .progress-bar{height:8px;background:#eee;border-radius:4px;overflow:hidden;margin-bottom:10px}
    .progress-fill{height:100%;border-radius:4px}
    .progress-fill.blue{background:linear-gradient(90deg,#4facfe,#00f2fe)}
    .progress-fill.green{background:linear-gradient(90deg,#11998e,#38ef7d)}
  </style>
</head>
<body>
  <div class="header">
    <h1>è¯å•åˆ†æå·¥å…·</h1>
    <p>æ”¯æŒ CSVã€XLSã€XLSX æ ¼å¼</p>
  </div>
  
  <div class="card" id="importCard">
    <h3>å¯¼å…¥è¯å•</h3>
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
      <p style="font-size:16px;margin-bottom:10px">ğŸ“‚ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
      <p style="color:#888;font-size:14px">æ”¯æŒ CSVã€XLSã€XLSXï¼Œå¯å¤šé€‰</p>
    </div>
    <input type="file" id="fileInput" multiple accept=".csv,.xls,.xlsx" style="display:none" onchange="handleFiles()">
    <div id="fileList" class="file-list"></div>
    <button class="btn btn-primary" onclick="analyze()">ğŸš€ å¼€å§‹åˆ†æ</button>
    <button class="btn btn-secondary" onclick="clearFiles()">ğŸ—‘ï¸ æ¸…é™¤</button>
  </div>

  <div class="card hidden" id="loadingCard">
    <p style="text-align:center;padding:30px">æ­£åœ¨è§£ææ–‡ä»¶...</p>
  </div>

  <div id="resultArea" class="hidden">
    <div class="stats-grid">
      <div class="stat-card"><div class="value" id="totalCalls">-</div><div class="label">æ€»é€šè¯æ¬¡æ•°</div></div>
      <div class="stat-card green"><div class="value" id="totalDuration">-</div><div class="label">æ€»é€šè¯æ—¶é•¿</div></div>
      <div class="stat-card orange"><div class="value" id="avgDuration">-</div><div class="label">å¹³å‡å•æ¬¡æ—¶é•¿</div></div>
      <div class="stat-card blue"><div class="value" id="totalContacts">-</div><div class="label">è”ç³»äººæ•°</div></div>
    </div>

    <div class="card">
      <h3>ä¸»å«/è¢«å«åˆ†å¸ƒ</h3>
      <p><span>ğŸ“´ ä¸»å«</span> <span id="outgoingText">0 (0%)</span></p>
      <div class="progress-bar"><div class="progress-fill blue" id="outgoingBar" style="width:0%"></div></div>
      <p><span>ğŸ“² è¢«å«</span> <span id="incomingText">0 (0%)</span></p>
      <div class="progress-bar"><div class="progress-fill green" id="incomingBar" style="width:0%"></div></div>
    </div>

    <div class="card">
      <h3>è”ç³»äººåˆ†æ</h3>
      <div class="tabs">
        <div class="tab active" onclick="showTab('frequency',this)">é€šè¯é¢‘æ¬¡</div>
        <div class="tab" onclick="showTab('strangers',this)">é™Œç”Ÿäºº</div>
        <div class="tab" onclick="showTab('frequent',this)">é«˜é¢‘è”ç³»äºº</div>
      </div>
      <div id="tab-frequency" class="tab-content active">
        <table><thead><tr><th>æ’å</th><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th><th>æœ€åé€šè¯</th></tr></thead><tbody id="frequencyBody"></tbody></table>
      </div>
      <div id="tab-strangers" class="tab-content">
        <table><thead><tr><th>å·ç </th><th>æ—¶é•¿</th><th>æ—¥æœŸ</th></tr></thead><tbody id="strangerBody"></tbody></table>
      </div>
      <div id="tab-frequent" class="tab-content">
        <table><thead><tr><th>å·ç </th><th>æ¬¡æ•°</th><th>æ—¶é•¿</th></tr></thead><tbody id="frequentBody"></tbody></table>
      </div>
    </div>

    <div class="card">
      <h3>æ—¶é—´åˆ†æ</h3>
      <div class="stats-grid">
        <div class="stat-card"><div class="value" id="peakHours">-</div><div class="label">é«˜å³°æ—¶æ®µ</div></div>
        <div class="stat-card green"><div class="value" id="peakDay">-</div><div class="label">é«˜å³°æ—¥</div></div>
        <div class="stat-card orange"><div class="value" id="nightCalls">-</div><div class="label">ç†¬å¤œæ¬¡æ•°</div></div>
        <div class="stat-card blue"><div class="value" id="nightRate">-</div><div class="label">ç†¬å¤œå æ¯”</div></div>
      </div>
    </div>
  </div>

  <script src="analyzer.js"></script>
  <script>
    var selectedFiles = [];
    var analyzer = new CallAnalyzer();

    function handleFiles() {
      var input = document.getElementById('fileInput');
      if (input.files.length > 0) {
        selectedFiles = Array.from(input.files);
        renderFileList();
      }
    }

    function renderFileList() {
      var container = document.getElementById('fileList');
      if (selectedFiles.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = selectedFiles.map(function(f, i) {
        return '<div class="file-item"><span>' + f.name + '</span><span style="color:#f5576c;cursor:pointer" onclick="removeFile(' + i + ')">âœ•</span></div>';
      }).join('');
    }

    function removeFile(i) {
      selectedFiles.splice(i, 1);
      document.getElementById('fileInput').value = '';
      renderFileList();
    }

    function clearFiles() {
      selectedFiles = [];
      document.getElementById('fileInput').value = '';
      renderFileList();
      document.getElementById('resultArea').className = 'hidden';
      document.getElementById('importCard').className = 'card';
    }

    function showTab(tabId, el) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
      el.classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
    }

    async function analyze() {
      if (selectedFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      document.getElementById('importCard').className = 'hidden';
      document.getElementById('loadingCard').className = 'card';
      
      analyzer.calls = [];
      
      for (var i = 0; i < selectedFiles.length; i++) {
        var file = selectedFiles[i];
        try {
          var data = await file.arrayBuffer();
          var workbook = XLSX.read(data);
          var sheet = workbook.Sheets[workbook.SheetNames[0]];
          var json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          var csv = json.map(function(row) {
            return row.map(function(c) { return String(c || ''); }).join(',');
          }).join('\n');
          var calls = analyzer.parseCSV(csv);
          for (var j = 0; j < calls.length; j++) {
            analyzer.calls.push(calls[j]);
          }
        } catch (e) {
          console.error('è§£æå¤±è´¥:', file.name, e);
        }
      }

      document.getElementById('loadingCard').className = 'hidden';
      document.getElementById('resultArea').className = '';

      // æ˜¾ç¤ºç»Ÿè®¡
      var stats = analyzer.getStatistics();
      var contacts = analyzer.getContactAnalysis();
      document.getElementById('totalCalls').textContent = stats.totalCalls + ' æ¬¡';
      document.getElementById('totalDuration').textContent = stats.totalDuration;
      document.getElementById('avgDuration').textContent = stats.avgDuration;
      document.getElementById('totalContacts').textContent = contacts.totalContacts + ' äºº';

      var incoming = stats.callTypes.incoming;
      var outgoing = stats.callTypes.outgoing;
      var total = incoming + outgoing;
      document.getElementById('incomingText').textContent = incoming + ' (' + (total ? Math.round(incoming/total*100) : 0) + '%)';
      document.getElementById('outgoingText').textContent = outgoing + ' (' + (total ? Math.round(outgoing/total*100) : 0) + '%)';
      document.getElementById('incomingBar').style.width = total ? incoming/total*100 + '%' : '0%';
      document.getElementById('outgoingBar').style.width = total ? outgoing/total*100 + '%' : '0%';

      // è”ç³»äºº
      document.getElementById('frequencyBody').innerHTML = contacts.topContacts.slice(0,20).map(function(c, i) {
        return '<tr><td>' + (i+1) + '</td><td>' + c.phone + '</td><td>' + c.count + ' æ¬¡</td><td>' + c.durationStr + '</td><td>' + (c.lastCall ? c.lastCall.split(' ')[0] : '-') + '</td></tr>';
      }).join('') || '<tr><td colspan="5" style="text-align:center;color:#888">æš‚æ— æ•°æ®</td></tr>';

      document.getElementById('strangerBody').innerHTML = contacts.strangerList.map(function(c) {
        return '<tr><td>' + c.phone + '</td><td>' + c.durationStr + '</td><td>' + (c.lastCall ? c.lastCall.split(' ')[0] : '-') + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é™Œç”Ÿäºº</td></tr>';

      document.getElementById('frequentBody').innerHTML = contacts.frequentList.map(function(c) {
        return '<tr><td>' + c.phone + '</td><td>' + c.count + ' æ¬¡</td><td>' + c.durationStr + '</td></tr>';
      }).join('') || '<tr><td colspan="3" style="text-align:center;color:#888">æš‚æ— é«˜é¢‘è”ç³»äºº</td></tr>';

      // æ—¶é—´
      var time = analyzer.getTimeAnalysis();
      document.getElementById('peakHours').textContent = time.peakHours.join('ã€') || '-';
      document.getElementById('peakDay').textContent = time.peakDay || '-';
      document.getElementById('nightCalls').textContent = time.nightCalls + ' æ¬¡';
      document.getElementById('nightRate').textContent = time.nightRate + '%';

      alert('åˆ†æå®Œæˆï¼å…± ' + analyzer.calls.length + ' æ¡è®°å½•');
    }
  </script>
</body>
</html>
